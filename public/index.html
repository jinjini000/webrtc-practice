<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Test</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #video-container {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      video {
        height: 300px;
        width: 300px;
        border: 1px solid black;
        background: #000;
      }
      .controlbox {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .messagebox {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>WebRTC Caller / Remote í…ŒìŠ¤íŠ¸</h1>

    <div class="controlbox">
      <button id="callButton">Call (ë°© ë§Œë“œëŠ” ìª½)</button>
      <button id="remoteButton">Remote (ì…ì¥í•˜ëŠ” ìª½)</button>
    </div>

    <div class="messagebox">
      <label for="message">
        Enter a message:
        <input
          type="text"
          name="message"
          id="message"
          placeholder="Message text"
          inputmode="latin"
          size="60"
          maxlength="120"
        />
      </label>
      <button id="sendButton">Send</button>
    </div>

    <div class="messagebox" id="receivebox">
      <p>Messages received:</p>
    </div>

    <div id="video-container">
      <div>
        <p>Local Video</p>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>
      <div>
        <p>Remote Video</p>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const callButton = document.getElementById("callButton");
      const remoteButton = document.getElementById("remoteButton");
      const messageInput = document.getElementById("message");
      const sendButton = document.getElementById("sendButton");
      const receivebox = document.getElementById("receivebox");
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");

      let pc = null; // RTCPeerConnection
      let localStream = null;
      let remoteStream = null;
      let dataChannel = null;
      let isCaller = false;

      callButton.addEventListener("click", startCall);
      remoteButton.addEventListener("click", prepareRemote);
      sendButton.addEventListener("click", sendMessage);

      // ===================== ê³µí†µ: PeerConnection ìƒì„± =====================

      function createPeerConnection() {
        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        console.log("PeerConnection ìƒì„±");

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("ICE Candidate ì „ì†¡:", event.candidate, isCaller);
            socket.emit("ice-candidate", event.candidate, isCaller);
          }
        };

        pc.ontrack = (event) => {
          console.log("Remote track ìˆ˜ì‹ :", event.streams);
          if (!remoteStream) {
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;
          }
          event.streams[0].getTracks().forEach((track) => {
            remoteStream.addTrack(track);
          });
        };

        pc.ondatachannel = (event) => {
          console.log("DataChannel ìˆ˜ì‹ ");
          dataChannel = event.channel;
          setupDataChannel();
        };
      }

      async function getLocalStream() {
        if (localStream) return;
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        localVideo.srcObject = localStream;
        console.log("Local stream ì–»ìŒ");
      }

      function addLocalTracks() {
        if (!localStream || !pc) return;
        localStream.getTracks().forEach((track) => {
          pc.addTrack(track, localStream);
        });
      }

      // ===================== Caller: ë°© ë§Œë“œëŠ” ìª½ =====================

      async function startCall() {
        isCaller = true;
        console.log("Caller ì‹œì‘");

        await getLocalStream();
        createPeerConnection();
        addLocalTracks();

        // Caller ê°€ DataChannel ìƒì„±
        dataChannel = pc.createDataChannel("chat");
        setupDataChannel();

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log("Offer ì „ì†¡");
        socket.emit("offer", offer);
      }

      // ===================== Remote: ì…ì¥í•˜ëŠ” ìª½ =====================

      async function prepareRemote() {
        isCaller = false;
        // Remote ê°€ Offer ì²˜ìŒ ë°›ì„ ë•Œ PeerConnection / LocalStream ì¤€ë¹„

        await getLocalStream();
        createPeerConnection();
        addLocalTracks();

        console.log("Remote ëª¨ë“œ ëŒ€ê¸° (offer ê¸°ë‹¤ë¦¬ëŠ” ì¤‘)");
        socket.emit("getOffer");
      }

      // ì„œë²„ì—ì„œ sendOffer ìˆ˜ì‹  â†’ Remoteê°€ ì²˜ë¦¬
      socket.on("sendOffer", async (offer) => {
        console.log("Offer ìˆ˜ì‹ ");

        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        console.log("RemoteDescription(Offer) ì„¤ì •");

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        console.log("Answer ì „ì†¡");
        socket.emit("answer", answer);

        // remoteDescription ì´ ì„¤ì •ë˜ì—ˆìœ¼ë‹ˆ, ëŒ€ê¸° ì¤‘ì´ë˜ ICE í›„ë³´ë“¤ ì²˜ë¦¬
        socket.emit("getIceOfCaller");
      });

      // ì„œë²„ì—ì„œ Answer ìˆ˜ì‹  â†’ Callerê°€ ì²˜ë¦¬
      socket.on("sendAnswer", async (answer) => {
        console.log("Answer ìˆ˜ì‹ ");
        if (!pc) {
          console.warn("pc ì—†ìŒ (Callerê°€ ì•„ë‹Œë° Answerë¥¼ ë°›ì€ ê²½ìš°?)");
          return;
        }
        if (isCaller) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
          console.log("âœ… RemoteDescription(Answer) ì„¤ì •");
        }
      });

      // ì„œë²„ì—ì„œ ICE í›„ë³´ ìˆ˜ì‹  (ì–‘ìª½ ê³µí†µ)
      socket.on("send-ice-candidate", async (candidate) => {
        console.log("ICE Candidate ìˆ˜ì‹ :", candidate);
        const iceCandidate = new RTCIceCandidate(candidate);

        if (pc && pc.remoteDescription && pc.remoteDescription.type) {
          try {
            await pc.addIceCandidate(iceCandidate);
            console.log("âœ… ICE í›„ë³´ ì¶”ê°€ ì™„ë£Œ");
          } catch (e) {
            console.error("ICE í›„ë³´ ì¶”ê°€ ì‹¤íŒ¨:", e);
          }
        }
      });

      socket.on("sendIceOfCaller", async (candidate) => {
        console.log("ICE Candidate ìˆ˜ì‹ :", candidate);
        const iceCandidate = new RTCIceCandidate(candidate);

        if (pc && pc.remoteDescription && pc.remoteDescription.type) {
          try {
            await pc.addIceCandidate(iceCandidate);
            console.log("âœ… ICE í›„ë³´ ì¶”ê°€ ì™„ë£Œ");
          } catch (e) {
            console.error("ICE í›„ë³´ ì¶”ê°€ ì‹¤íŒ¨:", e);
          }
        }
      });

      // ===================== DataChannel ê´€ë ¨ =====================

      function setupDataChannel() {
        if (!dataChannel) return;

        dataChannel.onopen = () => {
          console.log("DataChannel open");
        };

        dataChannel.onmessage = (event) => {
          console.log("DataChannel ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
          const p = document.createElement("p");
          p.textContent = "Remote: " + event.data;
          receivebox.appendChild(p);
        };

        dataChannel.onclose = () => {
          console.log("DataChannel closed");
        };
      }

      function sendMessage() {
        const text = messageInput.value;
        if (!dataChannel || dataChannel.readyState !== "open") {
          alert("DataChannel ì´ ì•„ì§ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          return;
        }
        if (!text) return;
        dataChannel.send(text);
        console.log("ğŸ’¬ DataChannel ë©”ì‹œì§€ ì „ì†¡:", text);

        const p = document.createElement("p");
        p.textContent = "Me: " + text;
        receivebox.appendChild(p);

        messageInput.value = "";
      }
    </script>
  </body>
</html>
